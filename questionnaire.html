<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discover Your Kin - Questionnaire</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        /* Custom animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-500 to-indigo-600 min-h-screen text-white flex items-center justify-center">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="text-center p-8 bg-white bg-opacity-20 rounded-xl shadow-2xl">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
            <p class="text-lg font-semibold">Loading...</p>
        </div>
    </div>

    <!-- Message Box Overlay -->
    <div id="message-box" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-white text-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="message-text" class="text-lg font-semibold mb-4"></p>
            <button id="message-ok-button" class="bg-indigo-600 text-white py-2 px-5 rounded-md hover:bg-indigo-700 transition">OK</button>
        </div>
    </div>

    <!-- Questionnaire Page Content -->
    <section id="questionnaire-page-content" class="flex-col items-center min-h-screen p-4">
        <div class="bg-white bg-opacity-20 p-8 rounded-xl shadow-2xl max-w-2xl w-full my-8 animate-fade-in">
            <h2 class="text-3xl font-bold mb-6 text-center">Tell Us About Yourself</h2>
            <form id="questionnaire-form" class="space-y-6">
                <!-- Questions will be dynamically inserted here by JavaScript -->
            </form>
            <button type="submit" form="questionnaire-form" id="submit-answers-button"
                class="w-full bg-white text-indigo-700 font-bold py-3 px-6 rounded-full shadow-lg hover:bg-indigo-100 transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-300 mt-6">
                Submit Answers
            </button>
            <p id="questionnaire-message" class="mt-4 text-center text-yellow-200"></p>
        </div>
    </section>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api'; // Ensure this matches your Flask backend URL

        // Utility functions for UI
        const showLoading = () => document.getElementById('loading-overlay').classList.remove('hidden');
        const hideLoading = () => document.getElementById('loading-overlay').classList.add('hidden');

        const showMessage = (msg, type = 'info') => {
            const msgBox = document.getElementById('message-box');
            const msgText = document.getElementById('message-text');
            msgText.textContent = msg;
            msgBox.classList.remove('hidden');
        };
        const hideMessage = () => document.getElementById('message-box').classList.add('hidden');
        document.getElementById('message-ok-button').addEventListener('click', hideMessage);

        // --- Global State Variables (loaded from localStorage) ---
        let currentUserId = localStorage.getItem('userId') || null;
        let userAnswers = JSON.parse(localStorage.getItem('userAnswers')) || {};

        // --- Questions Data (20 questions) ---
        const questions = [
            { id: 'q1', text: 'What was your family dynamic like?', type: 'multiple-choice', options: ['Supportive & Open', 'Strict & Traditional', 'Disconnected', 'Chaotic'] },
            { id: 'q2', text: 'Did you have a significant mentor in your life?', type: 'yes-no', options: ['Yes', 'No'] },
            { id: 'q3', text: 'Which value do you prioritize most?', type: 'multiple-choice', options: ['Honesty', 'Compassion', 'Freedom', 'Security'] },
            { id: 'q4', text: 'Do you believe people are inherently good?', type: 'yes-no', options: ['Yes', 'No'] },
            { id: 'q5', text: 'When solving a problem, what\'s your first step?', type: 'multiple-choice', options: ['Research', 'Brainstorm', 'Ask for help', 'Act quickly'] },
            { id: 'q6', text: 'Do you prefer detailed plans or spontaneous action?', type: 'multiple-choice', options: ['Detailed plans', 'Spontaneous action', 'Both', 'Neither'] },
            { id: 'q7', text: 'How do you react to criticism?', type: 'multiple-choice', options: ['Reflect & learn', 'Get defensive', 'Ignore it', 'Seek clarification'] },
            { id: 'q8', text: 'Are you more of an introvert or an extrovert?', type: 'multiple-choice', options: ['Introvert', 'Extrovert', 'Ambivert', 'Neither'] },
            { id: 'q9', text: 'What motivates you most?', type: 'multiple-choice', options: ['Personal growth', 'Helping others', 'Financial success', 'Recognition'] },
            { id: 'q10', text: 'Do you believe in destiny or free will?', type: 'yes-no', options: ['Destiny', 'Free Will'] },
            // --- New Questions (11-20) ---
            { id: 'q11', text: 'How do you typically handle stress?', type: 'multiple-choice', options: ['Exercise', 'Meditate', 'Talk to friends', 'Work harder'] },
            { id: 'q12', text: 'Are you generally optimistic or pessimistic?', type: 'multiple-choice', options: ['Optimistic', 'Pessimistic', 'Realistic', 'Depends'] },
            { id: 'q13', text: 'What role does creativity play in your life?', type: 'multiple-choice', options: ['Essential', 'Important', 'Minor', 'Not at all'] },
            { id: 'q14', text: 'Do you prefer working alone or in a team?', type: 'multiple-choice', options: ['Alone', 'Team', 'Both', 'Depends on task'] },
            { id: 'q15', text: 'How do you approach learning new things?', type: 'multiple-choice', options: ['Hands-on', 'Reading', 'Listening', 'Observing'] },
            { id: 'q16', text: 'Is routine important to you?', type: 'yes-no', options: ['Yes', 'No'] },
            { id: 'q17', text: 'How do you typically make big decisions?', type: 'multiple-choice', options: ['Logically', 'Intuitively', 'Consult others', 'Delay'] },
            { id: 'q18', text: 'What kind of challenges do you enjoy?', type: 'multiple-choice', options: ['Intellectual', 'Physical', 'Creative', 'Social'] },
            { id: 'q19', text: 'Do you learn more from success or failure?', type: 'multiple-choice', options: ['Success', 'Failure', 'Both equally', 'Neither'] },
            { id: 'q20', text: 'Is personal privacy very important to you?', type: 'yes-no', options: ['Yes', 'No'] }
        ];

        // --- Questionnaire Logic ---
        const questionnaireForm = document.getElementById('questionnaire-form');

        const renderQuestionnaire = () => {
            questionnaireForm.innerHTML = ''; // Clear previous questions
            questions.forEach(q => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-white bg-opacity-10 p-4 rounded-lg';
                questionDiv.innerHTML = `
                    <p class="text-lg font-semibold mb-3">${q.text}</p>
                    <div class="flex flex-wrap gap-3" id="options-${q.id}">
                        ${q.options.map(option => `
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="${q.id}" value="${option}"
                                    class="form-radio h-5 w-5 text-indigo-400 border-gray-300 focus:ring-indigo-300"
                                    ${userAnswers[q.id] === option ? 'checked' : ''}>
                                <span class="ml-2 text-white">${option}</span>
                            </label>
                        `).join('')}
                        <label class="inline-flex items-center cursor-pointer flex-grow">
                            <input type="radio" name="${q.id}" value="Other"
                                class="form-radio h-5 w-5 text-indigo-400 border-gray-300 focus:ring-indigo-300"
                                ${userAnswers[q.id] === 'Other' || (userAnswers[q.id] && !q.options.includes(userAnswers[q.id])) ? 'checked' : ''}>
                            <span class="ml-2 text-white">Other:</span>
                            <input type="text" id="${q.id}-other-input"
                                class="ml-2 p-2 rounded-md bg-white bg-opacity-30 border border-white border-opacity-50 placeholder-gray-200 focus:ring-2 focus:ring-indigo-300 focus:border-transparent outline-none flex-grow"
                                value="${userAnswers[q.id] === 'Other' || (userAnswers[q.id] && !q.options.includes(userAnswers[q.id])) ? userAnswers[q.id] : ''}"
                                ${userAnswers[q.id] === 'Other' || (userAnswers[q.id] && !q.options.includes(userAnswers[q.id])) ? 'required' : ''}>
                        </label>
                    </div>
                `;
                questionnaireForm.appendChild(questionDiv);

                // Add event listeners for radio buttons and other input
                const optionsContainer = document.getElementById(`options-${q.id}`);
                const otherInput = document.getElementById(`${q.id}-other-input`);

                optionsContainer.addEventListener('change', (e) => {
                    if (e.target.type === 'radio' && e.target.name === q.id) {
                        if (e.target.value === 'Other') {
                            userAnswers[q.id] = otherInput.value.trim() !== '' ? otherInput.value : 'Other';
                            otherInput.required = true;
                            otherInput.focus();
                        } else {
                            userAnswers[q.id] = e.target.value;
                            otherInput.required = false;
                            otherInput.value = ''; // Clear other input if a standard option is selected
                        }
                    }
                });

                otherInput.addEventListener('input', (e) => {
                    // Ensure 'Other' radio is selected if text is typed
                    const otherRadio = optionsContainer.querySelector(`input[name="${q.id}"][value="Other"]`);
                    if (otherRadio && !otherRadio.checked) {
                        otherRadio.checked = true;
                    }
                    userAnswers[q.id] = e.target.value;
                });

                otherInput.addEventListener('focus', () => {
                    const otherRadio = optionsContainer.querySelector(`input[name="${q.id}"][value="Other"]`);
                    if (otherRadio && !otherRadio.checked) {
                        otherRadio.checked = true;
                        userAnswers[q.id] = otherInput.value.trim() !== '' ? otherInput.value : 'Other';
                        otherInput.required = true;
                    }
                });
            });
        };

        document.getElementById('questionnaire-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            document.getElementById('questionnaire-message').textContent = '';

            // Validate all questions are answered
            const allAnswered = questions.every(q => {
                const answer = userAnswers[q.id];
                if (answer === undefined || answer === null || answer === '') return false;
                if (answer === 'Other' && document.getElementById(`${q.id}-other-input`).value.trim() === '') return false;
                return true;
            });

            if (!allAnswered) {
                showMessage("Please answer all questions before submitting.");
                hideLoading();
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/save_answers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUserId,
                        answers: userAnswers
                    })
                });
                const result = await response.json();

                if (response.ok) {
                    localStorage.setItem('userAnswers', JSON.stringify(userAnswers));
                    showMessage('Answers saved successfully!');
                    // Navigate to the new comparison options page
                    window.location.href = '/comparison.html';
                } else {
                    showMessage(`Error: ${result.error || 'Failed to save answers.'}`, 'error');
                }
            } catch (error) {
                console.error('Error saving answers:', error);
                showMessage('Network error or server unavailable.', 'error');
            } finally {
                hideLoading();
            }
        });

        // On page load, render the questionnaire
        window.onload = () => {
            if (!currentUserId || !localStorage.getItem('userProfile')) {
                // If no user ID or profile, redirect to profile page
                window.location.href = '/profile.html';
                return;
            }
            renderQuestionnaire();
        };
    </script>
</body>
</html>
